# 通知表所見自動生成ツール - 開発案

## 要件まとめ
- キーワード入力から自然な日本語の所見文を自動生成
- 学習面・生活面合わせて200文字程度（文字数指定可能）
- 作成した所見の一覧管理機能

---

## 案1: Webアプリケーション（Python + Streamlit + OpenAI API）

### 概要
シンプルなWebアプリとして、StreamlitでUIを構築し、OpenAI API（GPT-4/GPT-3.5）で文章生成を行う。

### 技術スタック
- **フロントエンド/バックエンド**: Streamlit（Python）
- **文章生成**: OpenAI API（GPT-4o-mini または GPT-3.5-turbo）
- **データ保存**: SQLite（ローカル）または PostgreSQL（本番）
- **デプロイ**: Streamlit Cloud または Docker

### メリット
- ✅ 開発が非常に簡単（Pythonのみで完結）
- ✅ UIが自動生成されるため、デザインに時間をかけない
- ✅ OpenAI APIで高品質な日本語生成が可能
- ✅ 無料でデプロイ可能（Streamlit Cloud）
- ✅ ローカルでもすぐに動かせる

### デメリット
- ❌ OpenAI APIの利用料金がかかる（ただしGPT-3.5-turboは安価）
- ❌ カスタマイズ性は限定的

### 実装イメージ
```
キーワード入力欄 → [生成]ボタン → 所見文表示 → [保存]ボタン
保存した所見一覧 → 編集・削除・コピー機能
```

### 想定コスト
- 開発: 無料（オープンソース）
- 運用: OpenAI API料金（月1000件で約500-1000円程度）

---

## 案2: Webアプリケーション（Next.js + TypeScript + ローカルLLM）

### 概要
モダンなWebアプリとして、Next.jsで構築し、ローカルで動くLLM（Llama 3.1 8Bなど）で文章生成を行う。

### 技術スタック
- **フロントエンド**: Next.js + TypeScript + Tailwind CSS
- **バックエンド**: Next.js API Routes
- **文章生成**: Ollama（ローカルLLM）または Hugging Face Transformers
- **データ保存**: SQLite または Supabase（PostgreSQL）
- **デプロイ**: Vercel（フロントエンド）+ 自前サーバー（LLM用）

### メリット
- ✅ 外部API不要で完全無料（ローカルLLM使用時）
- ✅ データが外部に送信されない（プライバシー重視）
- ✅ モダンなUI/UXを実現可能
- ✅ オフラインでも動作可能

### デメリット
- ❌ ローカルLLMのセットアップが必要
- ❌ 生成速度がやや遅い可能性
- ❌ サーバーリソースが必要（LLM実行用）

### 実装イメージ
```
キーワード入力 → 文字数指定 → [生成] → 所見文表示
一覧画面 → 検索・フィルタ・エクスポート機能
```

### 想定コスト
- 開発: 無料（オープンソース）
- 運用: サーバー代（月1000-3000円程度、ローカルLLM使用時）

---

## 案3: デスクトップアプリ（Python + Tkinter + テンプレートベース生成）

### 概要
ローカルで動作するデスクトップアプリとして、テンプレートとルールベースで文章を組み立てる方式。

### 技術スタック
- **UI**: Tkinter（Python標準ライブラリ）
- **文章生成**: テンプレートエンジン + ルールベースロジック
- **データ保存**: SQLite（ローカルファイル）
- **デプロイ**: PyInstallerでexe化

### メリット
- ✅ 完全無料（外部API不要、ライブラリも標準のみ）
- ✅ オフライン完結
- ✅ 軽量で起動が速い
- ✅ インストール不要で配布可能（exe化）

### デメリット
- ❌ 文章の自然さはAI生成に劣る可能性
- ❌ テンプレートのメンテナンスが必要
- ❌ UIがやや古めかしい

### 実装イメージ
```
キーワード選択（チェックボックス） → 文字数指定 → [生成]
生成ロジック: キーワード → テンプレート選択 → 文章組み立て
一覧画面 → CSV/Excelエクスポート機能
```

### 想定コスト
- 開発: 無料
- 運用: 無料

---

## 推奨案の比較

| 項目 | 案1（Streamlit + OpenAI） | 案2（Next.js + ローカルLLM） | 案3（Tkinter + テンプレート） |
|------|---------------------------|------------------------------|-------------------------------|
| **開発の簡単さ** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **文章の品質** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| **コスト** | 低（API料金） | 中（サーバー代） | 無料 |
| **プライバシー** | 中（API送信） | 高（ローカル） | 高（ローカル） |
| **UI/UX** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **配布の容易さ** | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |

---

## 推奨：案1（Streamlit + OpenAI API）

**理由:**
- 開発が最も簡単で、すぐに動くものが作れる
- 文章品質が高く、教師の満足度が高い
- コストも低く抑えられる（GPT-3.5-turbo使用時）
- 将来的にローカルLLMに切り替えることも可能

---

## 💰 案1の料金負担について（重要）

案1で他の人に提供する場合、**3つの選択肢**があります：

### 選択肢A: 使う人が各自でAPIキーを設定（推奨）

**仕組み:**
- 使う人（教師）が各自でOpenAI APIキーを取得
- アプリ起動時にAPIキーを入力（環境変数や設定ファイルに保存）
- 各自のAPIキーで利用するため、使う人が料金を負担

**メリット:**
- ✅ 提供する側（開発者）に料金負担がない
- ✅ 使う人が自分の利用量を管理できる
- ✅ プライバシー面でも安心（各自のAPIキーで利用）

**デメリット:**
- ❌ 使う人がAPIキー取得の手順を理解する必要がある
- ❌ 使う人にOpenAIアカウント作成が必要（無料枠あり）

**想定コスト（使う人）:**
- OpenAIアカウント作成: 無料
- 無料枠: 最初の$5分（約750円相当）が無料
- 以降: GPT-3.5-turbo使用時、月100件で約50-100円程度

---

### 選択肢B: ローカルLLM（Ollama）を使用（使う人は完全無料）

**仕組み:**
- 案1の技術スタックを少し変更
- OpenAI APIの代わりにOllama（ローカルLLM）を使用
- 使う人のPC上でLLMを実行するため、外部API不要

**メリット:**
- ✅ 使う人は完全無料
- ✅ データが外部に送信されない（プライバシー重視）
- ✅ オフラインでも動作可能

**デメリット:**
- ❌ 使う人がOllamaのインストールが必要
- ❌ 生成速度がやや遅い（5-10秒程度）
- ❌ PCのスペックが必要（8GB RAM以上推奨）

**実装:**
```python
# OpenAI APIの代わりにOllamaを使用
import ollama

response = ollama.generate(
    model='llama3.1:8b',
    prompt=prompt_text
)
```

---

### 選択肢C: 開発者が料金を負担（使う人は無料）

**仕組み:**
- 開発者が1つのOpenAI APIキーを共有
- サーバー側でAPIを呼び出し
- 使う人は無料で利用可能

**メリット:**
- ✅ 使う人は完全無料・手間なし

**デメリット:**
- ❌ 開発者が全員分の料金を負担
- ❌ 利用量が増えるとコストが高額になる可能性
- ❌ 悪用のリスク（APIキーの漏洩など）

**想定コスト（開発者）:**
- 10人使用、月100件/人 = 月1000件 → 約500-1000円
- 100人使用、月100件/人 = 月10000件 → 約5000-10000円

---

## 🎯 使う人の負担を最小化する最適解

### ⭐ 最推奨：選択肢C + Streamlit Cloudデプロイ

**使う人の負担:**
- ✅ **料金: 完全無料**
- ✅ **インストール: 不要（ブラウザでアクセスするだけ）**
- ✅ **設定: 不要（URLを開くだけ）**

**仕組み:**
1. 開発者がStreamlit Cloudにアプリをデプロイ
2. 開発者がOpenAI APIキーをStreamlit Cloudのsecretsに設定（1回だけ）
3. 使う人は提供されたURLをブラウザで開くだけ
4. アプリは開発者のAPIキーで動作（使う人は何も設定不要）

**メリット:**
- ✅ 使う人は完全無料・手間なし
- ✅ インストール不要（ブラウザのみ）
- ✅ どこからでもアクセス可能（スマホからも可）
- ✅ 自動更新（開発者が更新すると全員に反映）

**デメリット:**
- ❌ 開発者が料金を負担（ただしGPT-3.5-turboなら低コスト）
- ❌ インターネット接続が必要

**想定コスト（開発者）:**
- Streamlit Cloud: **完全無料**
- OpenAI API: 月1000件で約500-1000円程度（GPT-3.5-turbo使用時）
- 10人使用、月100件/人 = 月1000件 → **約500-1000円/月**
- 100人使用、月100件/人 = 月10000件 → **約5000-10000円/月**

**実装方針:**
- Streamlit Cloudにデプロイ
- APIキーはStreamlit Cloudのsecrets機能で管理
- 使う人はURLを共有するだけ

---

### 比較表：使う人の負担

| 項目 | 選択肢A<br>（各自APIキー） | 選択肢B<br>（ローカルLLM） | 選択肢C<br>（開発者負担） |
|------|---------------------------|---------------------------|---------------------------|
| **料金負担** | あり（無料枠あり） | なし | **なし** |
| **インストール** | 不要（ブラウザのみ） | **必要（Ollama）** | **不要（ブラウザのみ）** |
| **設定作業** | 必要（APIキー入力） | 必要（Ollama設定） | **不要** |
| **使いやすさ** | ⭐⭐⭐ | ⭐⭐ | **⭐⭐⭐⭐⭐** |

**結論: 使う人の負担を最小化するなら「選択肢C + Streamlit Cloud」が最適**

---

## 🎨 使いやすさの要件と実装方針

### 1. クリック1回で動く（実行ボタンだけで処理開始）

**実装方針:**
- メイン画面に「所見を生成」ボタンを1つだけ配置
- ボタンクリックで自動的に以下を実行：
  1. キーワードの取得（デフォルト値または前回の値）
  2. 文字数の確認（デフォルト200文字）
  3. API呼び出し
  4. 結果表示
  5. 自動保存（オプション）

**UIイメージ:**
```
┌─────────────────────────────────────┐
│  通知表所見自動生成ツール          │
├─────────────────────────────────────┤
│  キーワード: [積極的][協調性]...    │
│  文字数: [200] 文字                │
│                                     │
│  [🎯 所見を生成] ← これ1つだけ！   │
│                                     │
│  [生成中... 30%] ← 進捗表示        │
└─────────────────────────────────────┘
```

---

### 2. 入力をできるだけ減らす

**実装内容:**

#### 2-1. よく使うキーワードを覚える（履歴機能）
- 過去に入力したキーワードを自動保存
- 次回起動時に「よく使うキーワード」として表示
- ワンクリックで選択可能

**実装:**
```python
# SQLiteに履歴を保存
# 使用頻度の高いキーワードを上位表示
# チェックボックスで選択可能
```

#### 2-2. デフォルト値を設定
- 文字数: デフォルト200文字
- キーワード: 空欄でも「一般的な所見」を生成可能
- 前回の設定を自動復元

**実装:**
```python
# Streamlitのsession_stateで前回の値を保持
# またはSQLiteに設定を保存
```

#### 2-3. キーワードの自動補完
- よく使うキーワードをプルダウンで選択
- 例：「積極的」「協調性」「集中力」「創造性」など

**実装:**
```python
# プリセットキーワードリストを用意
# マルチセレクトボックスで選択
```

---

### 3. 分かりやすいエラーメッセージ

**実装方針:**
- 技術的なエラーを教師向けの分かりやすいメッセージに変換
- 解決方法を具体的に提示

**エラーメッセージ例:**

| 技術的エラー | 教師向けメッセージ |
|------------|------------------|
| `API key not found` | ⚠️ **APIキーが設定されていません**<br>→ 開発者に連絡してください |
| `Rate limit exceeded` | ⚠️ **リクエストが多すぎます**<br>→ 少し待ってから再度お試しください |
| `Network error` | ⚠️ **インターネット接続を確認してください**<br>→ Wi-Fiがつながっているか確認してください |
| `Invalid API key` | ⚠️ **APIキーが正しくありません**<br>→ 開発者に連絡してください |

**実装:**
```python
try:
    # API呼び出し
except Exception as e:
    error_message = get_user_friendly_error(e)
    st.error(f"⚠️ {error_message}")
    st.info("💡 解決方法: ...")
```

---

### 4. 進み具合を見せる（進捗表示）

**実装内容:**

#### 4-1. 生成中の進捗バー
- 「生成中... 30%」のような進捗表示
- ステップごとに進捗を更新

**実装:**
```python
import streamlit as st

progress_bar = st.progress(0)
status_text = st.empty()

# ステップ1: キーワード解析
status_text.text("📝 キーワードを解析中...")
progress_bar.progress(20)

# ステップ2: プロンプト生成
status_text.text("✍️ 文章を生成中...")
progress_bar.progress(50)

# ステップ3: 文字数調整
status_text.text("📏 文字数を調整中...")
progress_bar.progress(80)

# ステップ4: 完成
status_text.text("✅ 完成しました！")
progress_bar.progress(100)
```

#### 4-2. 一括生成時の進捗表示
- 複数の児童の所見を一括生成する場合
- 「30件中 10件完了...」のような表示

**実装:**
```python
total = 30
for i in range(total):
    st.progress((i + 1) / total)
    st.caption(f"📊 {i + 1}件中 {total}件完了...")
    # 生成処理
```

---

## 📤 共有しやすい方法

### 方法1: Streamlit Cloud（最推奨）

**手順:**
1. GitHubにコードをプッシュ
2. Streamlit Cloudでアプリをデプロイ
3. 共有URLを生成（例: `https://tuutihyou-app.streamlit.app`）
4. URLを共有するだけ

**メリット:**
- ✅ 完全無料
- ✅ URLを共有するだけ（インストール不要）
- ✅ 自動更新（コードを更新すると全員に反映）
- ✅ スマホからもアクセス可能

**共有方法:**
```
【通知表所見自動生成ツール】

以下のURLからアクセスできます：
https://tuutihyou-app.streamlit.app

使い方：
1. URLをクリック
2. キーワードを入力（または選択）
3. 「所見を生成」ボタンをクリック
4. 完成した所見をコピーして使用

※ 初回のみ少し時間がかかることがあります
```

---

### 方法2: QRコードで共有（⭐ 採用）

**手順:**
1. Streamlit CloudのURLを取得
2. アプリ内でQRコードを自動生成・表示
3. QRコードを印刷して配布（またはメールで送付）

**メリット:**
- ✅ スマホで簡単にアクセス可能（カメラでスキャンするだけ）
- ✅ 紙で配布できる（会議資料などに印刷可能）
- ✅ URLを手入力する必要がない
- ✅ アプリ内で自動生成されるため、手間がかからない

**実装詳細:**

#### 2-1. アプリ内にQRコードを表示
```python
import qrcode
from PIL import Image
import io

def generate_qr_code(url: str):
    """QRコードを生成して画像を返す"""
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_L,
        box_size=10,
        border=4,
    )
    qr.add_data(url)
    qr.make(fit=True)
    img = qr.make_image(fill_color="black", back_color="white")
    return img

# アプリ内で表示
app_url = "https://tuutihyou-app.streamlit.app"
qr_img = generate_qr_code(app_url)
st.image(qr_img, caption="📱 このQRコードをスキャンしてアクセス")
```

#### 2-2. サイドバーに常時表示
```python
with st.sidebar:
    st.header("📱 アプリの共有")
    qr_img = generate_qr_code(app_url)
    st.image(qr_img, caption="このQRコードをスキャン")
    st.caption("このQRコードを印刷して配布できます")
```

#### 2-3. 高解像度QRコードのダウンロード機能
```python
# 印刷用の高解像度QRコードを生成
high_res_qr = generate_qr_code(app_url)
high_res_qr = high_res_qr.resize((800, 800), Image.Resampling.LANCZOS)

# ダウンロードボタン
buf = io.BytesIO()
high_res_qr.save(buf, format='PNG')
st.download_button(
    label="📥 QRコードをダウンロード（印刷用）",
    data=buf.getvalue(),
    file_name="tuutihyou-qrcode.png",
    mime="image/png"
)
```

#### 2-4. 必要なライブラリ
```python
# requirements.txtに追加
qrcode[pil]>=7.4.2
Pillow>=10.0.0
```

---

### 方法3: ショートカットアイコン（PWA風）

**手順:**
1. Streamlit Cloudでデプロイ
2. スマホのホーム画面に追加
3. アプリのように使える

**メリット:**
- ✅ アプリのように使える
- ✅ ブックマークより簡単

**使い方（iPhone）:**
1. SafariでURLを開く
2. 共有ボタン → 「ホーム画面に追加」
3. ホーム画面にアイコンが表示される

---

### 方法4: ローカル配布（オフライン対応が必要な場合）

**手順:**
1. PyInstallerでexe化
2. ZIPファイルで配布
3. 解凍して実行するだけ

**メリット:**
- ✅ インターネット不要
- ✅ 完全オフライン

**デメリット:**
- ❌ 更新が面倒（再配布が必要）
- ❌ インストール手間がかかる

---

## 🎯 採用：Streamlit Cloud + QRコード共有

**採用理由:**
- ✅ 使う人はQRコードをスキャンするだけ（簡単）
- ✅ インストール不要
- ✅ 自動更新される（コード更新で全員に反映）
- ✅ 完全無料
- ✅ 紙で配布できる（会議資料などに印刷可能）

**共有手順:**
1. Streamlit Cloudにアプリをデプロイ
2. アプリ内でQRコードを自動生成・表示
3. QRコードを印刷して配布（またはメールで送付）
4. 使う人はスマホでQRコードをスキャンしてアクセス

**QRコードの表示場所:**
- アプリのサイドバーまたはフッターに常時表示
- 管理者画面でQRコードをダウンロード可能
- 印刷用の高解像度QRコードも生成可能

---

## 📋 実装の全体像

### 画面構成

```
┌─────────────────────────────────────────┐
│  通知表所見自動生成ツール              │
├─────────────────────────────────────────┤
│                                         │
│  【キーワード入力】                     │
│  ☑ 積極的  ☑ 協調性  ☑ 集中力         │
│  ☐ 創造性  ☐ 責任感  ☐ 思いやり       │
│                                         │
│  よく使うキーワード: [積極的][協調性]  │
│                                         │
│  【設定】                               │
│  文字数: [200] 文字                     │
│                                         │
│  [🎯 所見を生成] ← メインボタン        │
│                                         │
│  【進捗】                               │
│  ▓▓▓▓▓▓░░░░ 50%                        │
│  ✍️ 文章を生成中...                     │
│                                         │
│  【生成結果】                           │
│  ┌─────────────────────────────────┐   │
│  │ [生成された所見文が表示される]  │   │
│  └─────────────────────────────────┘   │
│  [📋 コピー] [💾 保存] [🔄 再生成]     │
│                                         │
│  【保存した所見一覧】                   │
│  📝 児童A - 2024/01/15 [編集][削除]   │
│  📝 児童B - 2024/01/15 [編集][削除]   │
│                                         │
└─────────────────────────────────────────┘
```

---

## 次のステップ:

1. **開発環境のセットアップ**
2. **Streamlitの基本構造作成**
3. **キーワード入力UI（履歴・デフォルト値対応）**
4. **進捗表示機能の実装**
5. **エラーハンドリング（分かりやすいメッセージ）**
6. **OpenAI API連携（文字数制御含む）**
7. **SQLiteでの保存・一覧表示機能**
8. **QRコード生成機能の実装**（サイドバー表示 + ダウンロード機能）
9. **Streamlit Cloudへのデプロイ**
10. **QRコードの印刷・配布準備**

---

## 📱 QRコード共有の実装優先度

**必須機能:**
- ✅ アプリ内でQRコードを自動生成・表示
- ✅ サイドバーに常時表示

**推奨機能:**
- ✅ 高解像度QRコードのダウンロード機能
- ✅ QRコードの印刷用説明文の表示

**実装タイミング:**
- QRコード生成機能は、Streamlit Cloudデプロイ後に実装
- デプロイ後のURLを取得してからQRコードを生成
